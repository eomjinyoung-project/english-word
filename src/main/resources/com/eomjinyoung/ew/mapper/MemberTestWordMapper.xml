<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eomjinyoung.ew.dao.MemberTestWordDao">

  <resultMap type="memberTestWord" id="memberTestWordMap">
    <id column="no" property="no"/>
    <result column="tdt" property="testingDate"/>
    <result column="step" property="step"/>
    <association property="word" javaType="word">
      <id column="w_no" property="no"/>
      <result column="w_name" property="name"/>
      <result column="w_meaning" property="meaning"/>
    </association>
    <association property="wordGroup" javaType="wordgroup">
      <id column="wg_no" property="no"/>
      <result column="wg_title" property="title"/>
    </association>
    <association property="member" javaType="member">
      <id column="m_no" property="no"/>
      <result column="m_username" property="username"/>
    </association>
  </resultMap>

  <sql id="selectColumns">
    tw.no,
    tw.tdt,
    tw.step,
    m.no as m_no,
    m.username as m_username,
    wg.no as wg_no,
    wg.title as wg_title,
    w.no as w_no,
    w.name as w_name,
    w.meaning as w_meaning
  </sql>
 
  <select id="findTestingWord" resultMap="memberTestWordMap" parameterType="map">
    select 
      <include refid="selectColumns"/>
    from ew_memb_tw tw
      left outer join ew_member m on m.no=tw.mno
      left outer join ew_wordgroup wg on wg.no=tw.wgno
      left outer join ew_word w on w.no=tw.wno
    <where>
      <if test="memberNo != null">
           tw.mno = #{memberNo}
      </if>
      <if test="wordGroupNo != null">
           and tw.wgno = #{wordGroupNo}
      </if>
      <if test="step != null">
           and tw.step = #{step}
      </if>
      <if test="testingDate != null">
           and tw.tdt = #{testingDate}
      </if>
    </where>
  </select>

  <update id="update" parameterType="map">
    update ew_memb_tw set
      tdt=date_add(tdt, interval #{addingDays} day),
      step=#{step}
    where 
      no=#{no}
  </update>
  
  <select id="countNewTestWord" resultType="int" parameterType="map">
    select 
      (select count(*) from ew_testword where wgno=#{wordGroupNo}) - 
      (select count(*) from ew_memb_tw where wgno=#{wordGroupNo} and mno=#{memberNo})
  </select>
  
  <insert id="insertAllNewTestWord" parameterType="map">
    insert into ew_memb_tw(tdt,step,mno,wgno,wno)
    select 
      curdate() as testing_date,
      0 as step,
      #{memberNo} as member_no,
      tw.wgno,
      tw.wno
    from 
      ew_testword tw
      left outer join (
        select * from ew_memb_tw where mno=#{memberNo}
      ) mtw on tw.wgno=mtw.wgno and tw.wno=mtw.wno
    where 
      tw.wgno=#{wordGroupNo} and mtw.mno is null
  </insert>
</mapper>



